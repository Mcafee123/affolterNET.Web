services:
  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    environment:
      - KC_BOOTSTRAP_ADMIN_USERNAME=${KEYCLOAK_ADMIN:-admin}
      - KC_BOOTSTRAP_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD:-admin}
      - KC_HEALTH_ENABLED=true
      - KC_HTTPS_CERTIFICATE_FILE=/opt/keycloak/conf/server.crt.pem
      - KC_HTTPS_CERTIFICATE_KEY_FILE=/opt/keycloak/conf/server.key.pem
      - KC_HOSTNAME=https://localhost:8443
      - KC_HOSTNAME_BACKCHANNEL_DYNAMIC=true
      - KC_HTTP_ENABLED=true
      - KC_LEGACY_OBSERVABILITY_INTERFACE=true
    command: start --import-realm --https-port=8443 --http-port=8080
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
      - ./certs:/opt/keycloak/conf:ro
    ports:
      - "8080:8080"
      - "8443:8443"
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080;echo -e 'GET /health/ready HTTP/1.1\\r\\nhost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3;if [ $? -eq 0 ]; then exit 0; else exit 1; fi"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - example-network

  keycloak-init:
    image: python:3.12-alpine
    depends_on:
      keycloak:
        condition: service_healthy
    environment:
      - KEYCLOAK_URL=https://keycloak:8443
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN:-admin}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD:-admin}
      - SSL_CERT_FILE=/certs/rootCA.pem
    volumes:
      - ./keycloak/fix-permissions.sh:/fix-permissions.sh:ro
      - ./certs:/certs:ro
    entrypoint: ["/bin/sh", "-c", "apk add --no-cache curl bash && bash /fix-permissions.sh"]
    networks:
      - example-network

  example-api:
    build:
      context: ..
      dockerfile: examples/ExampleApi/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=https://+:443;http://+:80
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/aspnetapp.pfx
      - ASPNETCORE_Kestrel__Certificates__Default__Password=password
      # Use HTTPS with custom CA for internal Docker communication
      - affolterNET__Web__Auth__Provider__AuthorityBase=https://keycloak:8443
      - affolterNET__Web__Auth__Provider__Realm=demo
      - affolterNET__Web__Auth__Provider__ClientId=api-client
      # Trust the mkcert CA
      - SSL_CERT_FILE=/https/rootCA.pem
      - AuthMode=Authorize
    volumes:
      - ./certs:/https:ro
    ports:
      - "5002:80"
      - "5003:443"
    depends_on:
      keycloak:
        condition: service_healthy
      keycloak-init:
        condition: service_completed_successfully
    networks:
      - example-network

  example-bff:
    build:
      context: ..
      dockerfile: examples/ExampleBff/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=https://+:443;http://+:80
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/aspnetapp.pfx
      - ASPNETCORE_Kestrel__Certificates__Default__Password=password
      # Use HTTPS with custom CA for internal Docker communication
      - affolterNET__Web__Auth__Provider__AuthorityBase=https://keycloak:8443
      - affolterNET__Web__Auth__Provider__Realm=demo
      - affolterNET__Web__Auth__Provider__ClientId=bff-client
      - affolterNET__Web__Auth__Provider__ClientSecret=${KEYCLOAK_CLIENT_SECRET:-bff-client-secret}
      # Trust the mkcert CA
      - SSL_CERT_FILE=/https/rootCA.pem
      # Use HTTPS for internal API proxy
      - affolterNET__ReverseProxy__Clusters__api-cluster__Destinations__api__Address=https://example-api:443
      - AuthMode=Authorize
    volumes:
      - ./certs:/https:ro
    ports:
      - "5001:80"
      - "5004:443"
    depends_on:
      keycloak:
        condition: service_healthy
      keycloak-init:
        condition: service_completed_successfully
      example-api:
        condition: service_started
    networks:
      - example-network

networks:
  example-network:
    driver: bridge
