services:
  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    environment:
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN:-admin}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD:-admin}
      - KC_HEALTH_ENABLED=true
      - KC_HTTPS_CERTIFICATE_FILE=/opt/keycloak/conf/server.crt.pem
      - KC_HTTPS_CERTIFICATE_KEY_FILE=/opt/keycloak/conf/server.key.pem
      - KC_HOSTNAME=localhost
    command: start-dev --import-realm --https-port=8443 --http-port=8080
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
      - ./certs:/opt/keycloak/conf:ro
    ports:
      - "8080:8080"
      - "8443:8443"
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && cat <&3 | grep -q '200 OK'"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - example-network

  example-api:
    build:
      context: ..
      dockerfile: examples/ExampleApi/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=https://+:443;http://+:80
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/aspnetapp.pfx
      - ASPNETCORE_Kestrel__Certificates__Default__Password=password
      # Use HTTPS with custom CA for internal Docker communication
      - affolterNET__Web__Auth__Provider__AuthorityBase=https://keycloak:8443
      - affolterNET__Web__Auth__Provider__Realm=demo
      - affolterNET__Web__Auth__Provider__ClientId=api-client
      # Trust the mkcert CA
      - SSL_CERT_FILE=/https/rootCA.pem
      - AuthMode=Authorize
    volumes:
      - ./certs:/https:ro
    ports:
      - "5002:80"
      - "5003:443"
    depends_on:
      keycloak:
        condition: service_healthy
    networks:
      - example-network

  example-bff:
    build:
      context: ..
      dockerfile: examples/ExampleBff/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=https://+:443;http://+:80
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/aspnetapp.pfx
      - ASPNETCORE_Kestrel__Certificates__Default__Password=password
      # Use HTTPS with custom CA for internal Docker communication
      - affolterNET__Web__Auth__Provider__AuthorityBase=https://keycloak:8443
      - affolterNET__Web__Auth__Provider__Realm=demo
      - affolterNET__Web__Auth__Provider__ClientId=bff-client
      - affolterNET__Web__Auth__Provider__ClientSecret=${KEYCLOAK_CLIENT_SECRET:-bff-client-secret}
      # Trust the mkcert CA
      - SSL_CERT_FILE=/https/rootCA.pem
      # Use HTTPS for internal API proxy
      - affolterNET__ReverseProxy__Clusters__api-cluster__Destinations__api__Address=https://example-api:443
      - AuthMode=Authorize
    volumes:
      - ./certs:/https:ro
    ports:
      - "5001:80"
      - "5004:443"
    depends_on:
      keycloak:
        condition: service_healthy
      example-api:
        condition: service_started
    networks:
      - example-network

networks:
  example-network:
    driver: bridge
